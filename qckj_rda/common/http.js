import config from './config'

// const _3_0_licence = 'cY5eGxTrRcvELb+ZjHv7Fa1SB3I2mciXRDSaAPeFu63XZZKWd4+lPyIuCH42xFo7XqaArdutrLWnb' +
// 	'0woIE3qfkphrCnJL2XkBP7FFwMb1CTPNE7uz3ZxjNPe6Mz7tTnY4reM34GBDsNwdic1N7GEuekE2pDx6MaNEzYqaMej3e2' +
// 	'9MhWcZW/ECBxFu7AJR8s1b5OLBi5J3alc3XVlwslTrAeGYdBSJDGGj9mAKIuf0QbNN2CCvxoNZ36/dUfI8oXAVearoxukt' +
// 	'ONwYa3IqHBcPKktSk7+lgrAdeO3LYR31kffN1Fw+56U81MJbIVW/FJv6VTa3p1wf6rDEfZNIUZLUA==H3DUu2nRnldsk0w' +
// 	'Ahr5aUJLs8UGNAhhpRcL34Ake00KHCPWAzlMvc8MIJRwnJBmWGVcYcg338l519VVIVKK3TzZhXZXYQw+ojNT7I+ENZ/lnA' +
// 	'WNGimt4ypdiD7w05voQKwk/RWKNkiWpoAlZ3saZi89xRQrxumepm/4qfDR8QcRcsQnKd06P+uWXh315EM9kKz8P/wFrkbe' +
// 	'2Y2Bt5SO5u9uCytycEoDgn/V7pe6hWA/JnHC6QhHmmzrYOg+D0+u/S/2SCHhX7qB7Q68sN+2bc1ftTY2obDNanfwKH4edf' +
// 	'zvd1PxainctyczTs55gv37yqk85VO0eue7Giyymzk8yhg==';
// const _3_0_licence = 'hIue4hM0oxci8uDrVmeJRMiYYfNEa2tob/qfnVumkNgAyirwqFm/F9nd9uX/fDFTRV2tlaufeuA66' +
// 	'FakTh0E3+6/IVgKVO9My9TZecQupbPircSuhzlw6B+jRmRQi1yxMKWAL9PjDnnPpBC/ho76HqTE4BQRdLqXEBDVGX303Gb' +
// 	'c/rqpE+Wji8ATklVf8H8XWk7eO9dgVBJMVNa2l1qZvGH5rgu+3QBErAp9iyosGwb+oNHHflaFtbxLzt6g/Y5tLr63gmtGx' +
// 	'nHahcBS9wFHZFh7PSCY2F/yzR5ViPZK3GNufbRVSpIAHo/hIRMdF+Jk+JySPgvcIhHTHCqN2kFshw==S/AkEpy4wFPDGNT' +
// 	'H+u8mSFMO6shC7gP6cNLeHbfCJdQFe+uIk/ZrR2AuLHFeGBQ38c8ikISBy6SxeCdlx8rr14bPAYwGsvsDPBwKDvwzqnG03' +
// 	'iwkVGMd4nY+XzBczig916b2uc+Qwl+TVAzoKOXcX2df/k7/wMG5bAlda5hgc91vmPJImq2JaipylJi7HjIplCobQ7xrlbW' +
// 	'vtosDvW3pL7UuYJkTZW3+Pkk3xZWt2ETckFVsd77cdKJGzwUCqKUCvESrnZv2BY5yt0TA6KeN1XLmH4juZBzxViThnxA3e' +
// 	'VTgf/Xcn+QyAF6Y+cesFYx/5MMcrRoicR7ATUm2+KfUtQ==';
// 生产环境licence
const _3_0_licence = config.config._3_0_licence;
	
	
// const _3_0_licence = 'TvalgFT8oN/MsnFmiQsC5RCxjpNMFvOJtsd879Zc036i1ZU6YqiQZDn8RpNqEOyoBIgWSSnc6HcYczN9fpJiJFnPgXVP1VmUMpm5Ly17+BH/0xaBfW4tkbGCJv87D7RFYqB5uuEkAgLBzylaF8/JsI+uWdddyzuwS/qdPtL9A+eP1M0ttzyeK0nJlF2s2dOyMmqMu/0/t0lNa0MNCh0YzVFe1EsMReoqE7FJhAU/gTa/grLa2qhDoZ77/BN3GKXjB7Zd6I+NgERfMq/viqAbc76acLwB6j1Yhf0LXbepSRs+xVNnnUtzC/79Qd5/KPfIJy5bgaDSPiNesMoTtz+nlw==yq011yRCGtjEzjdR8BfMy9XPfvTEvisLeQtHuBN8qgfqnDbbPbdprmbx8jUQ3mW/Jj5E2SQVFsfYsauouo6RhK1TTGkZ5vuH0mJpZtnJ8BIlGv+Ya1eSW7PdDSX9q7hkr+2h48iBhR1bFblRdUBHzYd7Qj3eDVuuPmpNP5Jvr9UCMlEVaksERgYIWxHH6ecKGcNMPNhcuULh04i6LduVyuBJoyCBJTsA5VupjtgBrQnUYgzKNGV+csFCJ+B3Tnk+s4RYBxJkwOt+hgOAEVE0IuwCFmVqpou58RL8NHMsNrryc4socYVqPo4QThsTLDxNF5CO8dc/b9goMREmq4tsWQ==';	
	
	// 172.16.4.225:60012
// 3.0生产环境
const _3_0_login = config.config._3_0_login;
const _3_0_report = config.config._3_0_report;

// 3.0罗均环境
// const _3_0_login = 'http://222.212.93.70:50020/qnms/V1_0_0/account/login';
// const _3_0_report = 'http://222.212.93.70:50020/communication/DeviceUpload';
const _mp_app_id = config.config._mp_app_id; // 小程序appid
const _mp_mch_id = config.config._mp_mch_id; // 商户号mchid
// http://172.16.108.31:8004（辜瑶）
// http://172.16.108.29:63137（测试环境）
// http://222.212.93.70:60094（牟建川）
const _7_0_openid = config.config._7_0_openid;
const _7_0_hostUrl = config.config._7_0_hostUrl;

const req_7_0_url = function(url) {
	let server = uni.getStorageSync('server_ip_port');
	if (0 == server.length) {
		server = 'http://222.212.93.70:60133'
	};
	
	console.log(server + url);
	return server + url;
}

// 封装 http request，用于调用 7.0 的接口
// data-json字符串，loading-是否显示加载框
// resolve-成功的回调，reject-失败的回调
const req_7_0 = function(data, loading, resolve, reject) {
	if (loading) uni.showLoading({
		mask: true,
		title: '请求中...'
	});
	
	uni.request({
		url: req_7_0_url(_7_0_hostUrl + data),
		method: 'GET',
		success: (res) => {
			if (200 !== res.statusCode) {
				reject('服务器异常');
				return;
			}
			let data = res.data;
			
			if (1 === data.ResultCode) {
				resolve(data);
			} else {
				reject(data.ResultMsg);
			}
		},
		fail: (e) => {
			reject('服务器异常');
		},
		complete: (e) => {
			console.log(e);
			if (loading) uni.hideLoading();
		}
	});
}

// 封装 http request，用于调用 3.0 的接口
// 首先判断 token 是否失效
const req_3_0 = function(data, loading, resolve, reject) {
	let _3_0_time = uni.getStorageSync('_3_0_time'),
		now_time = new Date().getTime();
	if (loading) uni.showLoading({
		mask: true,
		title: '请求中...'
	});
	if (_3_0_time && _3_0_time > now_time) { // 未失效
		req_3_0_report(data, loading, resolve, reject);
		return;
	}
	// token 失效，需要重新登录
	console.log("+++",_3_0_login);
	console.log("---",_3_0_licence);
	
	uni.request({
		url: _3_0_login,
		method: 'POST',
		data: {
			licence: _3_0_licence,
			tokenTime: 1440
		},
		success: (res) => {
			console.log(res);
			if (200 !== res.statusCode) {
				if (loading) uni.hideLoading();
				reject('服务器异常');
				return;
			}
			let resdata = res.data;
			if (200 !== resdata.resultCode) {
				if (loading) uni.hideLoading();
				reject(resdata.message);
				return;
			}
			let token = resdata.resultData.accessToken;
			let time = resdata.resultData.expireTime;
			uni.setStorageSync('_3_0_time', time);
			uni.setStorageSync('_3_0_token', token);
			req_3_0_report(data, loading, resolve, reject);
		},
		fail: (error) => {
			if (loading) uni.hideLoading();
			console.log(error);
			reject('服务器异常');
		}
	});
}

// 封装 http request，用于调用 3.0 的上报接口
const req_3_0_report = function(data, loading, resolve, reject) {
	let token = uni.getStorageSync('_3_0_token');
	console.log(data);
	uni.request({
		url: _3_0_report,
		method: 'POST',
		data: data,
		header: {
			Authorization: 'Bearer ' + token
		},
		success: (res) => {
			if (200 != res.statusCode) {
				reject('服务器异常');
				return;
			}
			let data = res.data;
			if (200 !== data.resultCode) {
				if (401 === data.resultCode)
					uni.removeStorageSync('_3_0_time');
				reject(data.message);
			} else {
				resolve(data.resultData);
			}
		},
		fail: (e) => reject('服务器异常'),
		complete: (res) => {
			console.log(res);
			if (loading) uni.hideLoading();
		}
	});
}

// 获取微信openid
const req_wx_openid = function(orgid, resolve, reject) {
	uni.login({
		provider: 'weixin',
		success: (resp) => {
			uni.request({
				url: req_7_0_url(_7_0_openid),
				method: 'GET',
				data: {
					appId: _mp_app_id,
					js_code: resp.code,
					orgid: orgid,
					grant_type: 'authorization_code'
				},
				success: (data) => {
					if (data.statusCode == 200) {
						resolve(data.data);
					} else {
						reject('');
					}
				},
				fail: (error) => reject(error)
			});
		},
		fail: (error) => reject(error)
	});
}

// 用户信息-查询应缴费用
const info = function(params) {
	return new Promise((resolve, reject) => {
		let data = JSON.stringify({
			OPType: 3,
			PayCode: '',
			RealMeterID: params.meterId,
		});
		req_7_0(data, true, resolve, reject);
	});
}

// 充值购气-支付（openid-下单-支付）
const pay = function(params) {
	return new Promise((resolve, reject) => {
		uni.showLoading({
			mask: true,
			title: '请求中...'
		});
		req_wx_openid(params.OrganCode, (weixin) => {
			console.log("++++++++------");
			console.log(weixin);
			let data = JSON.stringify({
				OPType: 26,
				PayCode: params.PayCode, // 缴费编号
				PreGas: params.PreGas, // 充值气量
				PreSave: params.PreSave, // 充值金额
				OtherMoney: params.OtherMoney, // 其他金额
				AllMoney: params.AllMoney, // 总金额
				TellerNumber: 'mp-weixin',
				appid: _mp_app_id, // 小程序的appid
				mch_id: _mp_mch_id, // 商户号的mchid
				openid: weixin.Data, // 小程序的openid
				PayType: '1', // 支付方式，1-微信
				CompanyCode: params.OrganCode,
			});
			
			console.log("------------------");
			console.log(data);
			
			req_7_0(data, false, (result) => {
				let pkid = result.prepay_id;
				uni.requestPayment({
					provider: uni.getProvider(),
					signType: 'MD5',
					paySign: result.sign, // 签名
					timeStamp: result.QueryStamp, // 时间戳
					nonceStr: result.nonce_str, // 随机字符串
					package: 'prepay_id=' + pkid, // prepay_id 
					fail: (error) => {
						uni.hideLoading();
						reject('支付失败');
					},
					success: (resp) => {
						uni.hideLoading();
						resolve({
							PayCode: result.PayCode,
							queryId: result.QueryID,
							free: params.AllMoney, // 总金额
							queryStamp: result.QueryStamp
						});
					}
				});
			}, (error) => {
				uni.hideLoading();
				reject('充值失败');
			});
		}, (error) => {
			uni.hideLoading();
			reject('充值失败');
		});
	});
}

// 订单查询
const query = function(params) {
	return new Promise((resolve, reject) => {
		let data = JSON.stringify({
			PayCode: params.PayCode, // 缴费编号
			free: params.free, // 总金额
			OPType: 27,
			appid: _mp_app_id, // 小程序的appid
			mch_id: _mp_mch_id, // 商户号的mchid
			queryId: params.queryId,
			queryStamp: params.queryStamp
		});
		req_7_0(data, true, resolve, reject);
	});
}

// 充值购气-下发指令
const cmd = function(params) {
	return new Promise((resolve, reject) => {
		let data = JSON.stringify({
			OPType: 5,
			PayCode: params.PayCode,
			PreGas: params.PreGas, // 购气量
			PreSave: params.PreSave, // 充值金额
			OtherMoney: params.OtherMoney, // 欠费金额
			AllMoney: params.AllMoney, // 总金额
			TellerNumber: 'mp-weixin', // 终端号
			PayType: '1', // 支付方式，1-微信
			OrganCode: params.OrganCode,
			ChargeRate: '0'
		});
		req_7_0(data, true, resolve, reject);
	});
}

// 透传指令-上报数据到3.0
// params.meterId 表号
// params.value 上报的数据，表端返回的指令
const report = function(params) {
	return new Promise((resolve, reject) => {
		req_3_0(params, true, resolve, reject);
	});
}

export default {
	info,
	pay,
	query,
	cmd,
	report
}


// 蓝牙水表、燃气表
// 微信开放平台id wxbaf4488c8e76d2f6
// 商户号 1289915201
// 商户支付密钥 cdqcjszx123456789012345678901234
// 公众账号secert 29ab82c31ac3695b7553a33a2c143d74
